# LLM Arena 任务清单

> **策略调整**：先用随机策略跑通基础流程，LLM 接入放到最后阶段。

## Phase 0: 项目初始化 ✅

- [x] 0.1 创建 `apps/llm_arena/` 目录结构
- [x] 0.2 配置 Cargo.toml（依赖：rust_pixel, serde, serde_json, rand）
- [x] 0.3 更新 workspace Cargo.toml（自动包含 apps/*）
- [x] 0.4 创建 lib.rs 和 main.rs 基础骨架
- [x] 0.5 创建 Model 和 Render 实现，确保编译通过

## Phase 1: core_sim 核心仿真

### 1.1 基础数据结构 ✅

- [x] 1.1.1 实现 `World` 结构体和基础字段
- [x] 1.1.2 实现 `Faction` 和 `Resources` 结构体
- [x] 1.1.3 实现 `Army` 结构体和属性计算方法
- [x] 1.1.4 实现 `BattleInstance` 和 `BattleParticipant`
- [x] 1.1.5 实现 `SafeZone` 结构体
- [x] 1.1.6 编写单元测试验证数据结构

### 1.2 世界 tick 循环 ✅

- [x] 1.2.1 实现 `World::tick()` 主循环
- [x] 1.2.2 实现军团移动逻辑
- [x] 1.2.3 实现资源消耗和采集逻辑
- [x] 1.2.4 实现安全区收缩逻辑（可配置）
- [x] 1.2.5 实现势力出局检测
- [x] 1.2.6 编写 tick 循环单元测试

### 1.3 遭遇与战斗 ✅

- [x] 1.3.1 实现半径遭遇检测 (`dist(a,b) <= R_encounter`)
- [x] 1.3.2 实现遭遇锁定与解除滞回
- [x] 1.3.3 实现 `BattleInstance` 创建和参与者加入
- [x] 1.3.4 实现战斗 tick 伤亡计算
- [ ] 1.3.5 实现士气下降和撤退触发
- [x] 1.3.6 实现战斗结束和结果处理
- [x] 1.3.7 编写战斗结算单元测试

### 1.4 deterministic 保证 ✅

- [x] 1.4.1 使用 `StdRng::seed_from_u64` 初始化 PRNG
- [x] 1.4.2 确保所有随机操作使用统一 PRNG
- [x] 1.4.3 确保实体处理顺序固定（按向量索引顺序，ID递增）
- [x] 1.4.4 实现状态快照和比较（`World::snapshot()` 方法）
- [x] 1.4.5 编写 deterministic 验证测试（8个单元测试通过）

## Phase 2: ai_protocol 协议层（后续）

### 2.1 Observation 生成 (3h)

- [ ] 2.1.1 定义 Observation JSON schema
- [ ] 2.1.2 实现视野计算（限视距）
- [ ] 2.1.3 实现情报衰减（timestamp + 过期）
- [ ] 2.1.4 实现 `World::generate_observation(faction_id)` 方法
- [ ] 2.1.5 编写 Observation 单元测试

### 2.2 Action 解析与校验 (3h)

- [ ] 2.2.1 定义 Action JSON schema
- [ ] 2.2.2 实现各类 Action 的 Rust 结构体
- [ ] 2.2.3 实现 Action 校验器（冷却、资源、可见性、范围）
- [ ] 2.2.4 实现 `World::apply_action(faction_id, action)` 方法
- [ ] 2.2.5 编写 Action 解析和校验单元测试

### 2.3 Replay 日志 (2h)

- [ ] 2.3.1 定义 ReplayLog 格式
- [ ] 2.3.2 实现每 tick 状态记录
- [ ] 2.3.3 实现 Observation hash 和 Action 记录
- [ ] 2.3.4 实现 Luck index 计算
- [ ] 2.3.5 实现 JSON/Binary 序列化

## Phase 3: agents 代理实现

### 3.1 Agent trait 定义 (1h)

- [ ] 3.1.1 定义 `Agent` trait（简化版，只需 `decide(&Observation) -> Vec<Action>`）
- [ ] 3.1.2 定义 `AgentConfig` 配置结构

### 3.2 Random Agent ✅

- [x] 3.2.1 实现随机军团移动（随机目标点）
- [ ] 3.2.2 实现随机战术设置
- [x] 3.2.3 确保生成的动作合法（边界检查）
- [x] 3.2.4 编写 Random Agent 单元测试

### 3.3 Simple Rule Agent - 可选

- [ ] 3.3.1 实现简单规则：追击最近敌人
- [ ] 3.3.2 实现简单规则：低血量撤退

## Phase 4: viewer 渲染层

### 4.1 Model 集成 ✅

- [x] 4.1.1 实现 `LlmArenaModel` 结构体
- [x] 4.1.2 集成 `World` 和 agents
- [x] 4.1.3 实现 `handle_timer` tick 推进
- [x] 4.1.4 实现 `handle_input` 控制处理

### 4.2 大地图渲染 ✅

- [x] 4.2.1 实现地图背景渲染
- [x] 4.2.2 实现资源点渲染
- [x] 4.2.3 实现军团 2×2 色块渲染
- [x] 4.2.4 实现战斗锁定圈渲染
- [ ] 4.2.5 实现安全区边界渲染
- [x] 4.2.6 实现视口滚动

### 4.3 战斗窗口（后续）

- [ ] 4.3.1 实现 80×45 战斗窗口 Scene
- [ ] 4.3.2 实现单位采样渲染
- [ ] 4.3.3 实现点群移动动画
- [ ] 4.3.4 实现子弹/激光特效（限额渲染）
- [ ] 4.3.5 实现爆炸特效
- [ ] 4.3.6 实现战斗摘要覆盖层

### 4.4 UI 面板

- [x] 4.4.1 实现资源面板（势力状态）
- [x] 4.4.2 实现排行榜面板（战斗信息）
- [ ] 4.4.3 实现事件流面板
- [x] 4.4.4 实现顶栏控制条
- [x] 4.4.5 实现倍速/暂停控制
- [x] 4.4.6 实现热键绑定

### 4.5 回放系统（后续）

- [ ] 4.5.1 实现回放加载
- [ ] 4.5.2 实现 tick 跳转
- [ ] 4.5.3 实现回放导出

## Phase 5: 集成测试与优化（后续）

### 5.1 集成测试

- [ ] 5.1.1 2 势力对战完整流程测试
- [ ] 5.1.2 多势力混战测试
- [ ] 5.1.3 seed 复现验证
- [ ] 5.1.4 性能基准测试

### 5.2 优化

- [ ] 5.2.1 大地图渲染优化（视口裁剪）
- [ ] 5.2.2 战斗动画优化（对象池）
- [ ] 5.2.3 内存优化
- [ ] 5.2.4 帧率稳定性优化

## Phase 6: LLM Agent 接入 - 最后实现

### 6.1 LLM Agent 基础

- [ ] 6.1.1 实现 HTTP 客户端封装（支持 OpenAI/Claude API）
- [ ] 6.1.2 实现 Observation → Prompt 转换
- [ ] 6.1.3 实现 LLM Response → Action 解析
- [ ] 6.1.4 实现超时处理和 fallback（降级到 Random Agent）

### 6.2 LLM Agent 增强

- [ ] 6.2.1 实现调用计数和 token 统计
- [ ] 6.2.2 实现调用预算限制
- [ ] 6.2.3 实现多模型支持（配置化）
- [ ] 6.2.4 编写 LLM Agent 集成测试

## Phase 7: 文档与发布（后续）

- [ ] 7.1 编写 README.md 使用指南
- [ ] 7.2 编写 AI 协议文档
- [ ] 7.3 编写配置文件说明
- [ ] 7.4 录制演示视频/GIF
- [ ] 7.5 更新主项目 README

---

## 📦 资源系统设计

### 资源类型（4种）

| 类型 | 名称 | 用途 | 产出 | 消耗 |
|-----|------|------|------|------|
| 0 | 食物(food) | 军团生存 | 食物资源点采集 | 每tick：troops × 0.001 |
| 1 | 💎宝石(gems) | 战略储备 | 宝石资源点采集 | 自动转化为食物/弹药 |
| 2 | 弹药(ammo) | 战斗输出 | 弹药资源点采集 | 战斗中每tick消耗 |
| 3 | 医疗(med) | 暂未使用 | 医疗资源点采集 | - |

### 军团属性

```rust
Army {
    supplies: f32,  // 食物补给 (0-150)
    ammo: f32,      // 弹药 (0-100)
    gems: f32,      // 宝石 (0-100) - 可转化为食物或弹药
}
```

### 采集规则

- 采集半径：R_GATHER = 3.0
- 采集速率：GATHER_RATE = 2.0/tick
- 只采集对应类型资源点
- 食物资源点 → supplies
- 宝石资源点 → gems
- 弹药资源点 → ammo

### 宝石转化规则 ✨

宝石是战略储备资源，当食物或弹药不足时自动转化：

| 转化条件 | 转化比例 | 每tick转化量 |
|---------|---------|-------------|
| supplies < 70 | 1宝石 → 2食物 | 1.0 |
| ammo < 50 (且食物充足) | 1宝石 → 2弹药 | 1.0 |

**转化优先级：** 食物 > 弹药

### 消耗规则

**食物消耗：**
- 每tick：`supplies -= troops × 0.001`
- 补给耗尽(<=0)：每tick饿死0.5%，士气-0.5

**弹药消耗：**
- 战斗中每tick：`ammo -= 0.5`
- 弹药耗尽(<=0)：战斗伤害输出降低50%

### 资源点

- 初始数量：20个（随机分布）
- 初始容量：50-200（随机）
- 再生速率：0.5/tick
- 最大容量：500

### AI行为

- supplies < 70：优先找食物资源点
- ammo < 30：优先找弹药资源点
- gems < 50：找宝石资源点（作为战略储备）
- 都充足：随机移动

---

## 📋 当前进度

**MVP-0 核心功能已完成：**
- ✅ 2 势力对战
- ✅ Random Agent 控制
- ✅ 军团移动、相遇、战斗
- ✅ 大地图渲染
- ✅ 中文日志输出
- ✅ Deterministic 验证（14个单元测试通过）
- ✅ 资源系统（食物、弹药、宝石）
- ✅ 宝石转化机制（增加策略性）

**下一步：**
1. 完善士气/撤退机制（可选, 1.3.5）
2. 添加更多势力支持
3. 考虑启动 Phase 2 AI协议层

---

**最后更新**: 2026-02-13
**状态**: Phase 1 基本完成
**当前阶段**: MVP-0 完成，准备 Phase 2
