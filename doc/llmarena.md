# LLM生存游戏策划

> 项目定位：基于 **rust_pixel** 打造一款“终端/TUI + 像素战场 + 可复盘联赛”的 **LLM 竞技生存游戏**。
>
> 一句话噱头：**同一张地图、同一初始资源，让不同大模型指挥像素军团生存，谁活到最后谁赢。**

---

## 0. 设计目标与原则

- **可观战**：信息密度高、战斗事件清晰、可倍速/暂停/回放。
- **可竞技**：信息对称、限视距、统一调用预算、可复盘可仲裁。
- **低美术成本**：颜色=阵营，几何=兵种，特效只做点/线/环。
- **高性能**：大地图抽象、局部战斗窗高密度；采用限额与抽样渲染。
- **可迭代**：核心仿真与 UI 解耦（core_sim 无渲染），能批量跑局做联赛。

---

## 1. 世界观

- **背景**：荒原/废土文明崩坏后，多个势力争夺最后的资源带。
- **主体**：每个势力由一个大模型（LLM Commander）指挥多个军团在大地图上行动。
- **结局**：某势力全部军团覆灭且无基地可再生产则出局，最后存活者胜。

### 1.1 反龟缩机制

- **安全区收缩（Zone）**：周期性缩圈，逼迫接触。
- **生态退化**：资源点产量随时间下降/枯竭。
- **维护压力递增**：人均消耗随时间增加，拖延不可持续。
- **战争迷雾**：限视距 + 情报过期衰减，避免上帝视角。

---

## 2. 游戏循环（Core Loop）

1. **侦查**：获取局部视野/情报。
2. **扩张与采集**：占资源点/据点，补充资源。
3. **机动与接触**：军团移动、阻截、追击。
4. **遭遇战**：相遇触发战斗实例；大地图显示战斗摘要。
5. **战报与复盘**：事件流记录，战斗窗可回放；联赛统计排名。

---

## 3. 数值体系（简洁但可产生策略分化）

### 3.1 势力资源（建议 ≤6）

- **Food**：军团/人口维持
- **Materials**：建造与维修（木/矿合并）
- **Ammo**：远程火力消耗
- **Med**：伤兵恢复、降低死亡
- **Energy/Morale**：行动效率/撤退概率/命中稳定
- **Pop**：可用人口（工人/士兵来源，可选；也可并入 Food 体系）

UI 必须显示：`当前值 + Δ/分钟`（增长/消耗斜率）

### 3.2 军团维持消耗（随时间递增）

- 基础人均消耗：`base_food_per_troop`
- 全局维护系数：
  - `M(t) = 1 + alpha * (t / T0)^beta`  （推荐：alpha=0.8, T0=10min, beta=1.2）
- 每 tick 消耗：
  - `food_cost = troops * base_food_per_troop * M(t)`
- 可选：随圈压力增加：`food_cost *= zone_pressure (1.0~1.5)`

### 3.3 崩盘规则（使资源管理有后果）

- Food < 0：军团持续掉兵/叛逃（或 morale 快速下降）
- Ammo 低：射击频率下降/远程变低效
- Med 低：伤亡转化为死亡比例上升，恢复时间延长
- Morale 低：命中波动变大、撤退概率上升

---

## 4. 军团体系（Army as the Unit）

### 4.1 大地图表现

- 一个军团 = **2×2 tiles 的闪烁色块**（阵营色）
- 亮度/闪烁频率可映射：兵力、士气、疲劳（低血变暗）

### 4.2 军团属性规划（问题1）

目标：少而有效，分为 **规模 / 质量 / 状态**。

**规模（体量）**
- `troops`：兵力（核心）
- `supplies`：随军补给（可选；也可直接从势力资源池扣）

**质量（战斗效率）**
- `atk`：攻击
- `def`：防御
- `range_type`：接战偏好（0近战/1远程/2炮击）
- `speed`：移动速度（大地图）
- `discipline`：纪律（降低随机波动、提升撤退稳定）

**状态（短期波动）**
- `morale`：0–100
- `fatigue`：0–100
- `intent`：采集/防守/进攻/撤退（供 LLM 控制）

#### 有效战力（可调、可复盘）
- `P = troops * Q`
- `Q = (1 + atk*kA - def*kD) * moraleFactor * fatigueFactor * supplyFactor`
  - `moraleFactor = 0.5 + morale/200`
  - `fatigueFactor = 1 - fatigue/150`
  - `supplyFactor = clamp(0.6..1.1, suppliesRatio)`
- 推荐初始：`kA=0.05, kD=0.03`

### 4.3 军团战术开关（给 LLM 策略空间）

（不做微操，给 3 个低成本开关即可）
- `stance`：Aggressive / Balanced / Defensive
  - Aggressive：输出↑ 伤亡↑
  - Defensive：减伤↑ 输出↓ 更易保命撤退
- `focus`：FocusFire / Spread / TargetSupport
- `retreat_threshold`：当 troops 或 morale 低于阈值触发撤退

---

## 5. 遭遇与战斗触发（问题2）

### 5.1 相遇检测方案

**推荐：半径相遇（确定性实现）**
- 军团位置使用定点/浮点坐标
- 每 tick 更新位置
- 若 `dist(a,b) <= R_encounter` 触发遭遇（建议 0.8 tile）

**最简备选：同格相遇**
- 同一 tile 出现敌对军团触发

### 5.2 防抖与锁定（边界处理）

- 遭遇触发后双方进入 `engaged_lock`（例如 30 tick）避免重复触发
- 使用滞回：解除条件 `dist > R_release`（R_release > R_encounter）

### 5.3 多方混战（关键边界）

- 若 A/B/C 同区域触发，建议第一版就支持 **多方战斗实例**：
  - 一个 `BattleInstance` 可包含多个参与势力/军团
  - 结算可简化为“按阵营累计 P”

### 5.4 战斗区域占用

- 战斗实例占据半径 2–3 tile 的危险区
- 其他军团路由默认绕开，除非选择 `join_battle`

---

## 6. 大地图战斗表现（问题3）

目标：不喧宾夺主，但让观众一眼看懂“在哪打、谁占优”。

- **战斗锁定圈**：在战斗点画环/方框
- **优势染色**：根据胜率估计或 P 比例，优势方更亮/劣势偏红
- **摘要标签**：
  - `A: 1200→980  |  B: 1100→600`（每 N tick 更新）
  - 或 `A 68% | B 32%`（胜率估计）
- **极简交火提示（可选）**：
  - 每 5 tick 画少量线段/点，严格限额（同屏 ≤30）

---

## 7. 小地图战斗窗与动画（问题4）

### 7.1 定位

- 小地图展示 **战斗动画与爽感**，但 **战斗输赢由逻辑层结算决定**。
- 动画必须受“结算曲线”驱动，避免结果违和。

### 7.2 战斗窗规格（建议）

- 尺寸：**80×45 tiles**（可观感“更大更多单位”）
- 战斗发生自动弹出，可钉住/回放

### 7.3 结算方式（短时持续，更好观战）

- 战斗持续 `T_battle = 50~150 ticks`（5~15 秒，按兵力可缩放）
- 每 tick 计算伤亡与士气变化（deterministic + seed 随机）

#### 推荐伤亡模型（可调、易复盘）
1. 计算各阵营有效战力 `P_i`
2. 计算阵营权重 `w_i = P_i / sum(P)`
3. 设基础强度 `c`（0.002~0.008）
4. 阵营 i 对阵营 j 的伤亡贡献：
   - `loss_j += round( c * P_i * noise_i * targetFactor(i,j) )`
   - `noise_i ∈ [0.85,1.15]`，discipline 高则收敛
5. morale：随损失比例下降；低于阈值触发撤退/溃退

> 第一版可仅支持 1v1；但建议尽早支持多方混战。

### 7.4 动画生成（弹幕式，但极简）

**表现原则**
- 只画采样点，不画真实 troop 数量：
  - `renderCount = clamp(50..400, troops/5)`
- 采用“点群推进/包围”营造战术感：
  - 优势方点群中心逐渐推进
  - 劣势方后撤并聚集，最终散开（溃退信号）

**极简特效三件套（严格限额 + 抽样）**
- 子弹：移动点（结算 100%，渲染抽样 20%~50%）
- 激光：短寿命线段（高科技/狙击），每阵营 ≤15
- 爆炸：2~3 帧扩张环或十字闪光，同屏 ≤80
- 命中反馈：单位闪白 1 帧，低血变暗

---

## 8. UI 与美术规范（低成本但有辨识度）

### 8.1 美术语言

- 阵营：颜色区分（≤8）
- 兵种：几何符号区分（4~6）
- 背景：深色底 + 简单网格/地形纹理

### 8.2 默认观战布局（继承“多窗口 TUI 仪表盘”）

- 顶栏：`Seed / Tick / Alive / Zone / Speed / Pause / Export`
- 左上资源面板：6 资源 + `Δ/分钟` + 告警闪烁
- 右侧固定两窗：
  - **Leaderboard**：Alive/Pop/Army/NetΔ/Token/Latency
  - **Event Feed**：遭遇、击杀、圈收缩、资源告急
- 浮窗模块（F1..F6）：Economy / Military / Intel / Stats / Models
- 自动弹窗：Battle Window（80×45）

### 8.3 大量单位但清晰的关键策略

- 单位使用 2×2 tiles，远景可聚合为 squad marker（含数量/亮度密度）
- 特效严格限额 + 抽样渲染，避免刷屏

---

## 9. API 操作接口（LLM 竞技核心）

### 9.1 仿真节奏

- 引擎：**10 tick/s**
- LLM 决策：**每 1s（10 tick）一次**
- 超时策略：沿用上次策略（或 fallback 保守 AI）
- 统一预算：`max_calls/min`、`max_tokens/call`、`timeout_ms`

### 9.2 Observation（限视距 + 情报衰减）

建议 JSON 字段：
- `meta`: match_id, seed, tick, zone, sim_speed
- `self`: resources, armies_summary, base_status
- `visible`:
  - `tiles`: 视野内地形/资源点/据点
  - `enemies`: 可见敌军摘要（位置、规模、兵种占比、最近动作）
- `intel`: 过往情报（带 timestamp，过期衰减）
- `events`: 最近 N tick 关键事件

### 9.3 Action（有限动作空间，强校验）

建议 8~10 类：
1. `assign_workers`（采集/建造/医疗比例）
2. `build`（营地/仓库/塔/医院/雷达…）
3. `form_army` / `merge_army`
4. `move_army`（目标点 + 路由风格：安全/最短/绕敌）
5. `scout`（方向/区域 + 强度）
6. `set_engagement_rules`（stance/focus/retreat_threshold）
7. `attack_target`（对可见目标/据点/战斗实例）
8. `join_battle` / `leave_battle`
9. `fortify`（驻守/修理/补给）
10. `research`（可选后续）

> 所有 action 必须校验：冷却、资源、可见性、范围合法。非法动作拒绝或降级。

---

## 10. 公平性、复盘与争议仲裁

- **信息对称**：同规则限视距 + 情报衰减
- **调用对称**：统一 token、频率、超时处理
- **deterministic**：seed + 固定顺序（军团 id 排序）+ PRNG 复现
- **replay log**：记录每次 obs hash、action、关键随机扰动摘要（Luck index）
- **成本指标上榜**：latency、tokens、call_count（“更聪明更省”）

---

## 11. 边界情况与处理清单（必须在规则里写死）

- **重复遭遇**：engaged_lock + 解除滞回 R_release
- **多方混战**：BattleInstance 支持多参与方（至少按阵营累计 P）
- **穿越战场**：战斗区域占用/危险区，默认绕行
- **动画与结果一致性**：动画由结算曲线驱动，溃退要有可视信号
- **随机性争议**：噪声范围小；discipline 降低波动；显示 Luck index
- **早期雪崩/后期集体饿死**：维护曲线用 S/幂函数；后期中心区高产点/击杀补给
- **出局定义**：无基地且所有军团 troops=0 则出局；无基地但有军团=游击存活（可选）

---

## 12. 工程分层建议（rust_pixel 友好）

1. `core_sim`：纯逻辑、deterministic、单元测试
2. `ai_protocol`：obs/action schema + 校验 + replay
3. `agents`：LLM agent / rule agent / random agent
4. `viewer`：rust_pixel UI（地图/窗口/回放）
5. `league_cli`（可选）：批量跑局、统计赛季榜

---

## 13. MVP 路线

### MVP-0（跑通闭环）
- 2 势力（LLM + 规则 AI）
- 军团移动、相遇、战斗实例
- 大地图锁定圈+摘要；小地图战斗动画
- seed + replay log

### MVP-1（可发布）
- 4~8 势力，多模型接入
- 统一预算、限视距
- 回放/倍速/导出
- Leaderboard + 成本指标

### MVP-2（联赛化/内容化）
- 赛季规则变体（圈快/慢、资源多/少）
- 批量跑局联赛、积分系统
- “战报卡片/高光时刻”自动生成

---

## 14. 待定的全局默认参数（建议首版采用）

- 大地图：256×256
- 遭遇半径：`R_encounter = 0.8 tile`，解除 `R_release = 1.2 tile`
- tick：10/s；LLM 决策频率：1s
- 战斗时长：8~12s（按 troops 缩放）
- 特效：点/线/环；子弹渲染抽样 33%，激光/爆炸限额
- 维护曲线：`alpha=0.8, T0=10min, beta=1.2`

---

## 15. 下一步落地建议（最省时间）

1. 先冻结 **规则白皮书 v0.1**（本策划即雏形）：字段、阈值、边界处理。
2. 定义 `Army / BattleInstance / EncounterEvent / BattleResult / ReplayLog` 数据结构。
3. 先实现 `core_sim` 的 deterministic tick 与战斗结算；再做 UI 与动画映射。
4. 最后接入多模型与联赛跑局。

